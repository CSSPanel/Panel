"use strict";(()=>{var e={};e.id=1686,e.ids=[1686],e.modules={43582:e=>{e.exports=require("@fabricio-191/valve-server-query")},429:e=>{e.exports=require("cookie-session")},62418:e=>{e.exports=require("mysql2/promise")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3511:e=>{e.exports=require("passport")},53686:e=>{e.exports=require("passport-steam")},99648:e=>{e.exports=import("axios")},97564:e=>{e.exports=import("chalk")},97612:e=>{e.exports=import("drizzle-orm")},99089:e=>{e.exports=import("drizzle-orm/mysql-core")},63024:e=>{e.exports=import("drizzle-orm/mysql2")},45616:e=>{e.exports=import("next-connect")},2782:e=>{e.exports=import("steam-api-sdk")},9926:e=>{e.exports=import("zod")},43555:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.r(a),r.d(a,{config:()=>w,default:()=>_,routeModule:()=>c});var n=r(71802),s=r(47153),o=r(56249),i=r(33589),p=e([i]);i=(p.then?(await p)():p)[0];let _=(0,o.l)(i,"default"),w=(0,o.l)(i,"config"),c=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/skins/gloves",pathname:"/api/skins/gloves",bundlePath:"",filename:""},userland:i});t()}catch(e){t(e)}})},33589:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.r(a),r.d(a,{default:()=>y});var n=r(7707),s=r(99863),o=r(89417),i=r(31158),p=r(79173),_=r(6346),w=r(17536),c=r(22692),l=r(13744),d=e([n,s,o,i,p,_,w,l]);[n,s,o,i,p,_,w,l]=d.then?(await d)():d;let y=async(e,a)=>{if(!p.Z)return a.status(500).json({message:"Database not connected"});if(!(await (0,s.ed)("skins")).enabled)return a.status(404).json({message:"Module not found"});await _.Z.run(e,a);let{method:r}=e,t=await (0,o.Z)(e,a);if(t)switch(r){case"GET":try{let e=await (0,w.Nf)(t.id);return a.status(200).json(e)}catch(e){return console.error(e),a.status(500).json({message:"Internal server error"})}case"POST":try{let r=t.id,s=i.Z.parse(e.body);return await Promise.all(c.uf.map(async e=>{e.weapon_defindex!==s.weapon_defindex&&await (0,l.YE)(r,e.weapon_defindex,s.weapon_team)})),await (0,w._q)({steamid:r,...s}),(0,n.x)(`css_fexec ${t.id} css_wp`),a.status(200).json({message:"Gloves set"})}catch(e){return console.error(e),a.status(500).json({message:"Internal server error"})}}};t()}catch(e){t(e)}})},7707:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{Z:()=>_,x:()=>p});var n=r(43582),s=r(79173),o=e([s]);s=(o.then?(await o)():o)[0];let i=async(e,a)=>{if(!s.Z)throw Error("Database not connected");try{let r=await s.Z.servers.getById(Number(e));if(!r)throw Error("Server not found");let{address:t,rcon:o}=r,[i,p]=t.split(":");if(!o)throw Error("Server has no rcon password");let _=await (0,n.RCON)({ip:i,port:Number(p),password:o,enableWarns:!0,retries:2,timeout:2e3});_.authenticate();let w=await _.exec(a);if(!w)return"No response from server";return w}catch(e){throw warn(`Error while sending rcon command: ${e}`),e}},p=async e=>{if(!s.Z)throw Error("Database not connected");let a=await s.Z.servers.getAll();return await Promise.all(a.map(async a=>{try{let r=await i(a.id,e);return{server:a.hostname,response:r}}catch(e){return{server:a.hostname,response:e}}}))},_=i;t()}catch(e){t(e)}})},6346:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{Z:()=>w});var n=r(79649),s=r(45616),o=r(429),i=r.n(o),p=e([s]);s=(p.then?(await p)():p)[0];let _=(0,s.default)();_.use(i()({secret:process.env.SESSION_SECRET||"secret",maxAge:10368e6})),_.use(n.Z.initialize()),_.use(n.Z.session());let w=_;t()}catch(e){t(e)}})},79649:(e,a,r)=>{r.d(a,{Z:()=>i});var t=r(3511),n=r.n(t),s=r(53686);n().serializeUser(async(e,a)=>{a(null,e)}),n().deserializeUser(async(e,a)=>{a(null,e)});let o=process.env.DOMAIN||"";o.startsWith("http")||(o=`https://${o}`),n().use(new s.Strategy({returnURL:`${o}/api/auth/return`,realm:`${o}/`,apiKey:process.env.STEAM_API_KEY||""},(e,a,r)=>(a.identifier=e,r(null,a))));let i=n()},89417:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{Z:()=>o});var n=r(79173),s=e([n]);n=(s.then?(await s)():s)[0];let o=(e,a)=>new Promise(async(r,t)=>n.Z?e.user?void r(e.user):t(a.status(400).json({success:!1,error:"Protected Route"})):a.status(500).json({message:"Database not connected"}));t()}catch(e){t(e)}})},31158:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{Z:()=>o});var n=r(9926),s=e([n]);let o=(n=(s.then?(await s)():s)[0]).z.object({weapon_defindex:n.z.number(),weapon_paint_id:n.z.number(),weapon_wear:n.z.number(),weapon_seed:n.z.number(),weapon_team:n.z.number(),weapon_nametag:n.z.nullable(n.z.string()),weapon_stattrak:n.z.number()});t()}catch(e){t(e)}})},17536:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{Nf:()=>w,_q:()=>l,wb:()=>c});var n=r(22692),s=r(3929),o=r(13744),i=r(97612),p=r(48057),_=e([s,o,i,p]);[s,o,i,p]=_.then?(await _)():_;let w=async e=>{if(!p.of)throw Error("No mysql connection");try{let a=await p.of.query.wp_player_gloves.findFirst({where:(0,i.eq)(s.wp_player_gloves.steamid,e)})||{weapon_defindex:0,steamid:e,weapon_team:0};return await p.of.query.wp_player_skins.findFirst({where:(0,i.and)((0,i.eq)(s.wp_player_gloves.steamid,e),(0,i.eq)(s.wp_player_gloves.weapon_defindex,a.weapon_defindex))}).then(r=>r?{steamid:e,weapon_defindex:a.weapon_defindex,weapon_paint_id:r.weapon_paint_id,weapon_wear:r.weapon_wear,weapon_seed:r.weapon_seed,weapon_team:a.weapon_team}:{steamid:e,weapon_defindex:a.weapon_defindex,weapon_paint_id:0,weapon_wear:0,weapon_seed:0,weapon_team:a.weapon_team})}catch(a){return console.error(a),{weapon_defindex:0,steamid:e,weapon_paint_id:0,weapon_wear:0,weapon_seed:0,weapon_team:0}}},c=async(e,a,r)=>{if(!p.of)throw Error("No mysql connection");try{await p.of.insert(s.wp_player_gloves).values({steamid:e,weapon_defindex:a,weapon_team:r}).onDuplicateKeyUpdate({set:{weapon_defindex:a,weapon_team:r}})}catch(e){throw Error("Failed to set player agent")}},l=async({steamid:e,weapon_defindex:a,weapon_paint_id:r,weapon_wear:t,weapon_seed:s,weapon_team:i})=>{try{c(e,a,i||0),(0,o.xI)({steamid:e,weapon_defindex:a,weapon_paint_id:r,weapon_wear:t,weapon_seed:s,weapon_team:i,weapon_keychain:n.Me,weapon_sticker_0:n.x8,weapon_sticker_1:n.x8,weapon_sticker_2:n.x8,weapon_sticker_3:n.x8,weapon_sticker_4:n.x8,weapon_nametag:null,weapon_stattrak:0})}catch(e){throw Error("Failed to set player agent")}};t()}catch(e){t(e)}})},13744:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{YE:()=>c,jx:()=>_,xI:()=>w});var n=r(22692),s=r(3929),o=r(97612),i=r(48057),p=e([s,o,i]);[s,o,i]=p.then?(await p)():p;let _=async e=>{if(!i.of)throw Error("No mysql connection");try{return(await i.of.query.wp_player_skins.findMany({where:(0,o.eq)(s.wp_player_skins.steamid,e)})||[{weapon_defindex:0,weapon_paint_id:0,weapon_seed:0,weapon_wear:1e-6,steamid:e}]).map(e=>({...e,weapon_sticker_0:(0,n.qQ)(e.weapon_sticker_0),weapon_sticker_1:(0,n.qQ)(e.weapon_sticker_1),weapon_sticker_2:(0,n.qQ)(e.weapon_sticker_2),weapon_sticker_3:(0,n.qQ)(e.weapon_sticker_3),weapon_sticker_4:(0,n.qQ)(e.weapon_sticker_4),weapon_keychain:(0,n.P_)(e.weapon_keychain)}))}catch(e){return console.error(e),[]}},w=async({steamid:e,weapon_defindex:a,weapon_wear:r,weapon_team:t,...p})=>{if(!i.of)throw Error("No mysql connection");try{if(0===t)console.debug("SetPlayerSkin","weapon_team is 0, removing all skins with the same defindex"),await i.of.delete(s.wp_player_skins).where((0,o.and)((0,o.eq)(s.wp_player_skins.steamid,e),(0,o.eq)(s.wp_player_skins.weapon_defindex,a)));else{let r=await i.of.select().from(s.wp_player_skins).where((0,o.and)((0,o.eq)(s.wp_player_skins.steamid,e),(0,o.eq)(s.wp_player_skins.weapon_defindex,a)));console.debug("SetPlayerSkin","weapon_team is not 0, removing all skins with the same defindex and team"),await i.of.delete(s.wp_player_skins).where((0,o.and)((0,o.eq)(s.wp_player_skins.steamid,e),(0,o.eq)(s.wp_player_skins.weapon_defindex,a),(0,o.eq)(s.wp_player_skins.weapon_team,t)));let n=r.some(e=>0===e.weapon_team),p=r.some(e=>0!==e.weapon_team&&e.weapon_team!==t);console.log({hasTeam0:n,hasOppositeTeam:p,itemSkins:r}),n&&p?(console.debug("SetPlayerSkin","removing team 0 skin"),await i.of.delete(s.wp_player_skins).where((0,o.and)((0,o.eq)(s.wp_player_skins.steamid,e),(0,o.eq)(s.wp_player_skins.weapon_defindex,a),(0,o.eq)(s.wp_player_skins.weapon_team,0)))):n&&await i.of.update(s.wp_player_skins).set({weapon_team:2===t?3:2}).where((0,o.and)((0,o.eq)(s.wp_player_skins.steamid,e),(0,o.eq)(s.wp_player_skins.weapon_defindex,a),(0,o.eq)(s.wp_player_skins.weapon_team,0)))}let[_]=await i.of.update(s.wp_player_skins).set({...p,weapon_wear:0===r?0:r,weapon_keychain:(0,n.Ky)(p.weapon_keychain),weapon_sticker_0:(0,n.i1)(p.weapon_sticker_0),weapon_sticker_1:(0,n.i1)(p.weapon_sticker_1),weapon_sticker_2:(0,n.i1)(p.weapon_sticker_2),weapon_sticker_3:(0,n.i1)(p.weapon_sticker_3),weapon_sticker_4:(0,n.i1)(p.weapon_sticker_4)}).where((0,o.and)((0,o.eq)(s.wp_player_skins.steamid,e),(0,o.eq)(s.wp_player_skins.weapon_defindex,a),0===t?void 0:(0,o.eq)(s.wp_player_skins.weapon_team,t)));0===_.affectedRows&&await i.of.insert(s.wp_player_skins).values({...p,steamid:e,weapon_defindex:a,weapon_team:t,weapon_wear:0===r?0:r,weapon_keychain:(0,n.Ky)(p.weapon_keychain),weapon_sticker_0:(0,n.i1)(p.weapon_sticker_0),weapon_sticker_1:(0,n.i1)(p.weapon_sticker_1),weapon_sticker_2:(0,n.i1)(p.weapon_sticker_2),weapon_sticker_3:(0,n.i1)(p.weapon_sticker_3),weapon_sticker_4:(0,n.i1)(p.weapon_sticker_4)})}catch(e){throw Error(`Failed to set player skin ${e}`)}},c=async(e,a,r)=>{if(!i.of)throw Error("No mysql connection");try{await i.of.delete(s.wp_player_skins).where((0,o.and)((0,o.eq)(s.wp_player_skins.steamid,e),(0,o.eq)(s.wp_player_skins.weapon_defindex,a),(0,o.eq)(s.wp_player_skins.weapon_team,r)))}catch(e){throw Error("Failed to delete player skin")}};t()}catch(e){t(e)}})}};var a=require("../../../webpack-api-runtime.js");a.C(e);var r=e=>a(a.s=e),t=a.X(0,[3337],()=>r(43555));module.exports=t})();