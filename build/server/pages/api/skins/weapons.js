"use strict";(()=>{var e={};e.id=3202,e.ids=[3202],e.modules={43582:e=>{e.exports=require("@fabricio-191/valve-server-query")},429:e=>{e.exports=require("cookie-session")},62418:e=>{e.exports=require("mysql2/promise")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3511:e=>{e.exports=require("passport")},53686:e=>{e.exports=require("passport-steam")},99648:e=>{e.exports=import("axios")},97564:e=>{e.exports=import("chalk")},97612:e=>{e.exports=import("drizzle-orm")},99089:e=>{e.exports=import("drizzle-orm/mysql-core")},63024:e=>{e.exports=import("drizzle-orm/mysql2")},45616:e=>{e.exports=import("next-connect")},2782:e=>{e.exports=import("steam-api-sdk")},9926:e=>{e.exports=import("zod")},98833:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.r(a),r.d(a,{config:()=>w,default:()=>_,routeModule:()=>c});var s=r(71802),n=r(47153),i=r(56249),o=r(78574),p=e([o]);o=(p.then?(await p)():p)[0];let _=(0,i.l)(o,"default"),w=(0,i.l)(o,"config"),c=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/skins/weapons",pathname:"/api/skins/weapons",bundlePath:"",filename:""},userland:o});t()}catch(e){t(e)}})},78574:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.r(a),r.d(a,{default:()=>m});var s=r(13744),n=r(7707),i=r(99863),o=r(9926),p=r(89417),_=r(79173),w=r(6346),c=e([s,n,i,o,p,_,w]);[s,n,i,o,p,_,w]=c.then?(await c)():c;let l=o.z.object({id:o.z.number(),x:o.z.number(),y:o.z.number(),wear:o.z.number(),scale:o.z.number(),rotation:o.z.number(),schema:o.z.number()}),d=o.z.object({weapon_defindex:o.z.number(),weapon_paint_id:o.z.number(),weapon_team:o.z.number(),weapon_wear:o.z.number(),weapon_seed:o.z.number(),weapon_nametag:o.z.nullable(o.z.string()),weapon_stattrak:o.z.number(),weapon_sticker_0:l,weapon_sticker_1:l,weapon_sticker_2:l,weapon_sticker_3:l,weapon_sticker_4:l,weapon_keychain:o.z.object({id:o.z.number(),x:o.z.number(),y:o.z.number(),z:o.z.number(),seed:o.z.number()})}),m=async(e,a)=>{if(!_.Z)return a.status(500).json({message:"Database not connected"});if(!(await (0,i.ed)("skins")).enabled)return a.status(404).json({message:"Module not found"});await w.Z.run(e,a);let{method:r}=e,t=await (0,p.Z)(e,a);if(t)switch(r){case"GET":try{let e=await (0,s.jx)(t.id);return a.status(200).json(e)}catch(e){return console.error(e),a.status(500).json({message:"Internal server error"})}case"POST":try{let r=d.parse(e.body);return await (0,s.xI)({steamid:t.id,...r}),(0,n.x)(`css_fexec ${t.id} css_wp`),a.status(201).end()}catch(e){return console.error(e),a.status(500).json({message:"Internal server error"})}}};t()}catch(e){t(e)}})},7707:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{Z:()=>_,x:()=>p});var s=r(43582),n=r(79173),i=e([n]);n=(i.then?(await i)():i)[0];let o=async(e,a)=>{if(!n.Z)throw Error("Database not connected");try{let r=await n.Z.servers.getById(Number(e));if(!r)throw Error("Server not found");let{address:t,rcon:i}=r,[o,p]=t.split(":");if(!i)throw Error("Server has no rcon password");let _=await (0,s.RCON)({ip:o,port:Number(p),password:i,enableWarns:!0,retries:2,timeout:2e3});_.authenticate();let w=await _.exec(a);if(!w)return"No response from server";return w}catch(e){throw warn(`Error while sending rcon command: ${e}`),e}},p=async e=>{if(!n.Z)throw Error("Database not connected");let a=await n.Z.servers.getAll();return await Promise.all(a.map(async a=>{try{let r=await o(a.id,e);return{server:a.hostname,response:r}}catch(e){return{server:a.hostname,response:e}}}))},_=o;t()}catch(e){t(e)}})},6346:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{Z:()=>w});var s=r(79649),n=r(45616),i=r(429),o=r.n(i),p=e([n]);n=(p.then?(await p)():p)[0];let _=(0,n.default)();_.use(o()({secret:process.env.SESSION_SECRET||"secret",maxAge:10368e6})),_.use(s.Z.initialize()),_.use(s.Z.session());let w=_;t()}catch(e){t(e)}})},79649:(e,a,r)=>{r.d(a,{Z:()=>o});var t=r(3511),s=r.n(t),n=r(53686);s().serializeUser(async(e,a)=>{a(null,e)}),s().deserializeUser(async(e,a)=>{a(null,e)});let i=process.env.DOMAIN||"";i.startsWith("http")||(i=`https://${i}`),s().use(new n.Strategy({returnURL:`${i}/api/auth/return`,realm:`${i}/`,apiKey:process.env.STEAM_API_KEY||""},(e,a,r)=>(a.identifier=e,r(null,a))));let o=s()},89417:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{Z:()=>i});var s=r(79173),n=e([s]);s=(n.then?(await n)():n)[0];let i=(e,a)=>new Promise(async(r,t)=>s.Z?e.user?void r(e.user):t(a.status(400).json({success:!1,error:"Protected Route"})):a.status(500).json({message:"Database not connected"}));t()}catch(e){t(e)}})},13744:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{YE:()=>c,jx:()=>_,xI:()=>w});var s=r(22692),n=r(3929),i=r(97612),o=r(48057),p=e([n,i,o]);[n,i,o]=p.then?(await p)():p;let _=async e=>{if(!o.of)throw Error("No mysql connection");try{return(await o.of.query.wp_player_skins.findMany({where:(0,i.eq)(n.wp_player_skins.steamid,e)})||[{weapon_defindex:0,weapon_paint_id:0,weapon_seed:0,weapon_wear:1e-6,steamid:e}]).map(e=>({...e,weapon_sticker_0:(0,s.qQ)(e.weapon_sticker_0),weapon_sticker_1:(0,s.qQ)(e.weapon_sticker_1),weapon_sticker_2:(0,s.qQ)(e.weapon_sticker_2),weapon_sticker_3:(0,s.qQ)(e.weapon_sticker_3),weapon_sticker_4:(0,s.qQ)(e.weapon_sticker_4),weapon_keychain:(0,s.P_)(e.weapon_keychain)}))}catch(e){return console.error(e),[]}},w=async({steamid:e,weapon_defindex:a,weapon_wear:r,weapon_team:t,...p})=>{if(!o.of)throw Error("No mysql connection");try{if(0===t)console.debug("SetPlayerSkin","weapon_team is 0, removing all skins with the same defindex"),await o.of.delete(n.wp_player_skins).where((0,i.and)((0,i.eq)(n.wp_player_skins.steamid,e),(0,i.eq)(n.wp_player_skins.weapon_defindex,a)));else{let r=await o.of.select().from(n.wp_player_skins).where((0,i.and)((0,i.eq)(n.wp_player_skins.steamid,e),(0,i.eq)(n.wp_player_skins.weapon_defindex,a)));console.debug("SetPlayerSkin","weapon_team is not 0, removing all skins with the same defindex and team"),await o.of.delete(n.wp_player_skins).where((0,i.and)((0,i.eq)(n.wp_player_skins.steamid,e),(0,i.eq)(n.wp_player_skins.weapon_defindex,a),(0,i.eq)(n.wp_player_skins.weapon_team,t)));let s=r.some(e=>0===e.weapon_team),p=r.some(e=>0!==e.weapon_team&&e.weapon_team!==t);console.log({hasTeam0:s,hasOppositeTeam:p,itemSkins:r}),s&&p?(console.debug("SetPlayerSkin","removing team 0 skin"),await o.of.delete(n.wp_player_skins).where((0,i.and)((0,i.eq)(n.wp_player_skins.steamid,e),(0,i.eq)(n.wp_player_skins.weapon_defindex,a),(0,i.eq)(n.wp_player_skins.weapon_team,0)))):s&&await o.of.update(n.wp_player_skins).set({weapon_team:2===t?3:2}).where((0,i.and)((0,i.eq)(n.wp_player_skins.steamid,e),(0,i.eq)(n.wp_player_skins.weapon_defindex,a),(0,i.eq)(n.wp_player_skins.weapon_team,0)))}let[_]=await o.of.update(n.wp_player_skins).set({...p,weapon_wear:0===r?0:r,weapon_keychain:(0,s.Ky)(p.weapon_keychain),weapon_sticker_0:(0,s.i1)(p.weapon_sticker_0),weapon_sticker_1:(0,s.i1)(p.weapon_sticker_1),weapon_sticker_2:(0,s.i1)(p.weapon_sticker_2),weapon_sticker_3:(0,s.i1)(p.weapon_sticker_3),weapon_sticker_4:(0,s.i1)(p.weapon_sticker_4)}).where((0,i.and)((0,i.eq)(n.wp_player_skins.steamid,e),(0,i.eq)(n.wp_player_skins.weapon_defindex,a),0===t?void 0:(0,i.eq)(n.wp_player_skins.weapon_team,t)));0===_.affectedRows&&await o.of.insert(n.wp_player_skins).values({...p,steamid:e,weapon_defindex:a,weapon_team:t,weapon_wear:0===r?0:r,weapon_keychain:(0,s.Ky)(p.weapon_keychain),weapon_sticker_0:(0,s.i1)(p.weapon_sticker_0),weapon_sticker_1:(0,s.i1)(p.weapon_sticker_1),weapon_sticker_2:(0,s.i1)(p.weapon_sticker_2),weapon_sticker_3:(0,s.i1)(p.weapon_sticker_3),weapon_sticker_4:(0,s.i1)(p.weapon_sticker_4)})}catch(e){throw Error(`Failed to set player skin ${e}`)}},c=async(e,a,r)=>{if(!o.of)throw Error("No mysql connection");try{await o.of.delete(n.wp_player_skins).where((0,i.and)((0,i.eq)(n.wp_player_skins.steamid,e),(0,i.eq)(n.wp_player_skins.weapon_defindex,a),(0,i.eq)(n.wp_player_skins.weapon_team,r)))}catch(e){throw Error("Failed to delete player skin")}};t()}catch(e){t(e)}})}};var a=require("../../../webpack-api-runtime.js");a.C(e);var r=e=>a(a.s=e),t=a.X(0,[3337],()=>r(98833));module.exports=t})();