"use strict";(()=>{var e={};e.id=4324,e.ids=[4324],e.modules={1428:e=>{e.exports=import("axios")},3498:e=>{e.exports=require("mysql2/promise")},10070:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{L:()=>u,n:()=>o});var s=r(12072),i=r(19582),n=e([i]);i=(n.then?(await n)():n)[0];let o=async()=>{try{if(!i.A)throw Error("Database not connected");let e=await i.A.settings.getByKey("paypalClientId"),t=await i.A.settings.getByKey("paypalClientSecret",!1),r=await i.A.settings.getByKey("paypalLiveMode",!1),a=await i.A.settings.getByKey("currency");if(!e||!t)throw Error("Paypal credentials not found");return s.Config.clientId=e,s.Config.clientSecret=t,s.Config.mode=r?"LIVE":"SANDBOX",(0,s.Init)(e,t,r?"LIVE":"SANDBOX"),{paypalClientId:e,paypalClientSecret:t,paypalLiveMode:r,currency:a}}catch(e){throw Error(`Failed to setup paypal ${e}`)}},u=async({item:e,total:t})=>{try{if(!i.A)throw Error("Database not connected");let r=await i.A.settings.getByKey("currency"),a=t.toFixed(2),n=await s.Orders.create({intent:"CAPTURE",purchase_units:[{amount:{currency_code:r||"USD",value:a,breakdown:{item_total:{currency_code:r||"USD",value:a}}},items:[{name:e,quantity:"1",unit_amount:{currency_code:r||"USD",value:a},category:"DIGITAL_GOODS"}]}]}),o=n.links.find(e=>"approve"===e.rel);if(!o)throw Error("No payment link found");return{order:n,paymenLink:o.href}}catch(e){throw error("Failed to create order",e),Error(`Failed to create order ${e}`)}};a()}catch(e){a(e)}})},10788:e=>{e.exports=import("drizzle-orm/mysql-core")},11737:e=>{e.exports=import("drizzle-orm")},12072:e=>{e.exports=require("paypal-jsdk")},22282:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>l});var s=r(46958),i=r(81198),n=r(10070),o=r(12072),u=r(43580),c=r(19582),p=r(93204),d=e([s,i,n,u,c,p]);[s,i,n,u,c,p]=d.then?(await d)():d;let l=async(e,t)=>{if(!c.A)return t.status(500).json({message:"Database not connected"});if(!(await (0,s.iF)("buy-vip")).enabled)return t.status(404).json({message:"Module not found"});await (0,n.n)(),await p.A.run(e,t);let{method:r}=e;if(await (0,u.A)(e,t)&&"POST"===r)try{let{orderId:r}=e.body;if(!r)return t.status(400).json({message:"Missing parameters"});let a=await c.A.settings.getByKey("buyVip");if(!a)return t.status(404).json({message:"Buy VIP module not found"});let s=await c.A.payments.getByOrderId(r);if(!s)return t.status(404).json({message:"Order not found"});await o.Orders.capturePayment(r),await c.A.payments.update(s.id,{status:"COMPLETED"});let n=a.plans.find(e=>e.id===s.itemId);if(!n)return t.status(404).json({message:"VIP package not found"});return await (0,i.UH)(s.userId,n.group,n.days),t.status(201).json({message:"Payment captured"})}catch(e){return error(e),t.status(500).json({message:"Internal server error",err:e})}};a()}catch(e){a(e)}})},31562:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>p,default:()=>c,routeModule:()=>d});var s=r(13088),i=r(57987),n=r(77355),o=r(22282),u=e([o]);o=(u.then?(await u)():u)[0];let c=(0,n.M)(o,"default"),p=(0,n.M)(o,"config"),d=new s.PagesAPIRouteModule({definition:{kind:i.A.PAGES_API,page:"/api/buy-vip/capture",pathname:"/api/buy-vip/capture",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},38218:e=>{e.exports=import("steam-api-sdk")},42971:e=>{e.exports=import("zod")},43580:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{A:()=>n});var s=r(19582),i=e([s]);s=(i.then?(await i)():i)[0];let n=(e,t)=>new Promise(async(r,a)=>s.A?e.user?void r(e.user):a(t.status(400).json({success:!1,error:"Protected Route"})):t.status(500).json({message:"Database not connected"}));a()}catch(e){a(e)}})},75600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},76404:e=>{e.exports=import("next-connect")},80169:e=>{e.exports=import("chalk")},80546:e=>{e.exports=import("drizzle-orm/mysql2")},81198:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{UH:()=>c});var s=r(72477),i=r(38218),n=r(11737),o=r(51107),u=e([s,i,n,o]);[s,i,n,o]=u.then?(await u)():u;let c=async(e,t,r,a="ADD")=>{try{if(!o.Dx)throw Error("No mysql connection");let u=17===e.length?Number((0,i.From64To32)(e)):Number(e);log(e,u);let c=r&&r>0?p(r):0,d=await o.Dx.query.vip_users.findFirst({where:(0,n.eq)(s.A.account_id,u)});if(d)"ADD"===a?d.expires+=c:c>0?d.expires=Math.floor(Date.now()/1e3)+c:d.expires=0,await o.Dx.update(s.A).set({group:t,expires:d.expires}).where((0,n.eq)(s.A.account_id,u)),log(`Updated vip for user ${e} with group ${t} and expiration ${d.expires}`);else{let a=Math.floor(Date.now()/1e3),i=r&&r>0?a+c:0;await o.Dx.insert(s.A).values({account_id:u,group:t,expires:i,lastvisit:0,name:"CSS-Panel",sid:0}),log(`Gave vip to user ${e} with group ${t} and expiration ${i}`)}}catch(e){error(`An error occurred while giving vip to user: ${e}`)}},p=e=>86400*e;a()}catch(e){a(e)}})},88691:e=>{e.exports=require("cookie-session")},93204:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{A:()=>p});var s=r(95621),i=r(76404),n=r(88691),o=r.n(n),u=e([i]);i=(u.then?(await u)():u)[0];let c=(0,i.default)();c.use(o()({secret:process.env.SESSION_SECRET||"secret",maxAge:10368e6})),c.use(s.A.initialize()),c.use(s.A.session());let p=c;a()}catch(e){a(e)}})},95621:(e,t,r)=>{r.d(t,{A:()=>o});let a=require("passport");var s=r.n(a);let i=require("passport-steam");s().serializeUser(async(e,t)=>{t(null,e)}),s().deserializeUser(async(e,t)=>{t(null,e)});let n=process.env.DOMAIN||"";n.startsWith("http")||(n=`https://${n}`),s().use(new i.Strategy({returnURL:`${n}/api/auth/return`,realm:`${n}/`,apiKey:process.env.STEAM_API_KEY||""},(e,t,r)=>(t.identifier=e,r(null,t))));let o=s()}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[937],()=>r(31562));module.exports=a})();