"use strict";(()=>{var e={};e.id=1836,e.ids=[1836],e.modules={429:e=>{e.exports=require("cookie-session")},62418:e=>{e.exports=require("mysql2/promise")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3511:e=>{e.exports=require("passport")},53686:e=>{e.exports=require("passport-steam")},19652:e=>{e.exports=require("paypal-jsdk")},99648:e=>{e.exports=import("axios")},97564:e=>{e.exports=import("chalk")},97612:e=>{e.exports=import("drizzle-orm")},99089:e=>{e.exports=import("drizzle-orm/mysql-core")},63024:e=>{e.exports=import("drizzle-orm/mysql2")},45616:e=>{e.exports=import("next-connect")},2782:e=>{e.exports=import("steam-api-sdk")},9926:e=>{e.exports=import("zod")},58349:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>p,default:()=>c,routeModule:()=>l});var s=r(71802),i=r(47153),n=r(56249),o=r(3488),u=e([o]);o=(u.then?(await u)():u)[0];let c=(0,n.l)(o,"default"),p=(0,n.l)(o,"config"),l=new s.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/buy-vip/capture",pathname:"/api/buy-vip/capture",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},3488:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>d});var s=r(99863),i=r(22826),n=r(99107),o=r(19652),u=r(89417),c=r(79173),p=r(6346),l=e([s,i,n,u,c,p]);[s,i,n,u,c,p]=l.then?(await l)():l;let d=async(e,t)=>{if(!c.Z)return t.status(500).json({message:"Database not connected"});if(!(await (0,s.ed)("buy-vip")).enabled)return t.status(404).json({message:"Module not found"});await (0,n.F)(),await p.Z.run(e,t);let{method:r}=e;if(await (0,u.Z)(e,t)&&"POST"===r)try{let{orderId:r}=e.body;if(!r)return t.status(400).json({message:"Missing parameters"});let a=await c.Z.settings.getByKey("buyVip");if(!a)return t.status(404).json({message:"Buy VIP module not found"});let s=await c.Z.payments.getByOrderId(r);if(!s)return t.status(404).json({message:"Order not found"});await o.Orders.capturePayment(r),await c.Z.payments.update(s.id,{status:"COMPLETED"});let n=a.plans.find(e=>e.id===s.itemId);if(!n)return t.status(404).json({message:"VIP package not found"});return await (0,i.ml)(s.userId,n.group,n.days),t.status(201).json({message:"Payment captured"})}catch(e){return error(e),t.status(500).json({message:"Internal server error",err:e})}};a()}catch(e){a(e)}})},22826:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{ml:()=>c});var s=r(2457),i=r(2782),n=r(48057),o=r(97612),u=e([s,i,n,o]);[s,i,n,o]=u.then?(await u)():u;let c=async(e,t,r,a="ADD")=>{try{if(!n.of)throw Error("No mysql connection");let u=17===e.length?Number((0,i.From64To32)(e)):Number(e);log(e,u);let c=r&&r>0?p(r):0,l=await n.of.query.vip_users.findFirst({where:(0,o.eq)(s.Z.account_id,u)});if(l){if("ADD"===a)l.expires+=c;else if(c>0){let e=Math.floor(Date.now()/1e3);l.expires=e+c}else l.expires=0;await n.of.update(s.Z).set({group:t,expires:l.expires}).where((0,o.eq)(s.Z.account_id,u)),log(`Updated vip for user ${e} with group ${t} and expiration ${l.expires}`)}else{let a=Math.floor(Date.now()/1e3),i=r&&r>0?a+c:0;await n.of.insert(s.Z).values({account_id:u,group:t,expires:i,lastvisit:0,name:"CSS-Panel",sid:0}),log(`Gave vip to user ${e} with group ${t} and expiration ${i}`)}}catch(e){error(`An error occurred while giving vip to user: ${e}`)}},p=e=>86400*e;a()}catch(e){a(e)}})},99107:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{F:()=>o,p:()=>u});var s=r(19652),i=r(79173),n=e([i]);i=(n.then?(await n)():n)[0];let o=async()=>{try{if(!i.Z)throw Error("Database not connected");let e=await i.Z.settings.getByKey("paypalClientId"),t=await i.Z.settings.getByKey("paypalClientSecret",!1),r=await i.Z.settings.getByKey("paypalLiveMode",!1),a=await i.Z.settings.getByKey("currency");if(!e||!t)throw Error("Paypal credentials not found");return s.Config.clientId=e,s.Config.clientSecret=t,s.Config.mode=r?"LIVE":"SANDBOX",(0,s.Init)(e,t,r?"LIVE":"SANDBOX"),{paypalClientId:e,paypalClientSecret:t,paypalLiveMode:r,currency:a}}catch(e){throw Error(`Failed to setup paypal ${e}`)}},u=async({item:e,total:t})=>{try{if(!i.Z)throw Error("Database not connected");let r=await i.Z.settings.getByKey("currency"),a=t.toFixed(2),n=await s.Orders.create({intent:"CAPTURE",purchase_units:[{amount:{currency_code:r||"USD",value:a,breakdown:{item_total:{currency_code:r||"USD",value:a}}},items:[{name:e,quantity:"1",unit_amount:{currency_code:r||"USD",value:a},category:"DIGITAL_GOODS"}]}]}),o=n.links.find(e=>"approve"===e.rel);if(!o)throw Error("No payment link found");return{order:n,paymenLink:o.href}}catch(e){throw error("Failed to create order",e),Error(`Failed to create order ${e}`)}};a()}catch(e){a(e)}})},6346:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{Z:()=>p});var s=r(79649),i=r(45616),n=r(429),o=r.n(n),u=e([i]);i=(u.then?(await u)():u)[0];let c=(0,i.default)();c.use(o()({secret:process.env.SESSION_SECRET||"secret",maxAge:10368e6})),c.use(s.Z.initialize()),c.use(s.Z.session());let p=c;a()}catch(e){a(e)}})},79649:(e,t,r)=>{r.d(t,{Z:()=>o});var a=r(3511),s=r.n(a),i=r(53686);s().serializeUser(async(e,t)=>{t(null,e)}),s().deserializeUser(async(e,t)=>{t(null,e)});let n=process.env.DOMAIN||"";n.startsWith("http")||(n=`https://${n}`),s().use(new i.Strategy({returnURL:`${n}/api/auth/return`,realm:`${n}/`,apiKey:process.env.STEAM_API_KEY||""},(e,t,r)=>(t.identifier=e,r(null,t))));let o=s()},89417:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{Z:()=>n});var s=r(79173),i=e([s]);s=(i.then?(await i)():i)[0];let n=(e,t)=>new Promise(async(r,a)=>s.Z?e.user?void r(e.user):a(t.status(400).json({success:!1,error:"Protected Route"})):t.status(500).json({message:"Database not connected"}));a()}catch(e){a(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[3337],()=>r(58349));module.exports=a})();